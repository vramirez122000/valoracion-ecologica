<!DOCTYPE html>
<html>
<head>

    <title>Valoración Ecológica de Playuela</title>

    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico"/>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
    <script src="geostats.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"
            integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
            crossorigin="anonymous"></script>

</head>
<body style="border: 0; margin: 0; padding: 0">


<div id="mapid" style="width: 100%; height: 800px; margin: 0; padding: 0; border: 0"></div>
<script>

    var mapElem = document.querySelector('#mapid');
    var viewportHeight = document.documentElement.clientHeight;
    mapElem.style.height = '' + viewportHeight + 'px';

    var map = L.map('mapid').setView([18.47903, -67.16239], 16);
    var greens = ['#f7fcfd', '#e5f5f9', '#ccece6', '#99d8c9', '#66c2a4', '#41ae76', '#238b45', '#005824'];

    /*L.tileLayer.wms('https://raster.nationalmap.gov/arcgis/services/Orthoimagery/USGS_EROS_Ortho_1Foot/ImageServer/WMSServer?', {
        layers: 'USGS_EROS_Ortho_1Foot',
        format: 'image/jpeg',
        version: '1.3.0'
        //transparent: false,
        //attribution: "USACE"
    }).addTo(map);*/
    
    /*L.tileLayer('http://{s}.tile.openstreetmap.us/usgs_large_scale/{z}/{x}/{y}.jpg', {
        maxZoom: 18,
        subdomains: 'abc'
    }).addTo(map);*/

    L.tileLayer('http://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            
    }).addTo(map);

    var colors = {
        'beach': '#b35806',
        'commercial': '#5dba56',
        'farmland': '#c358ba',
        'golf_course': '#fdb863',
        'grass': '#8068cc',
        'grassland': '#d98c3c',
        'reef': '#678ecd',
        'residential': '#d0473a',
        'rock': '#50b8a2',
        'scrub': '#c65b8a',
        'wetland': '#568542',
        'wood': '#977e3d'
    };

    /*$.getJSON("poligonos-uso-cubierta.geojson", function (data) {
     L.geoJSON(data, {
     style: function (feature) {
     return {
     opacity: 0.9,
     color: colors[feature.properties.landuse]
     };
     }
     }).bindPopup(function (layer) {
     var props = layer.feature.properties;
     return props.gid + ' (' + props.landuse + ')';
     }).addTo(map);
     });*/

    $.getJSON("poligonos-valor.geojson", function (data) {
        var stats = new geostats(data.features.map(function (feature) {
            return Number(feature.properties.usd_per_ha);
        }));
        var jenks = stats.getClassJenks(greens.length);

        var geoJsonLyr = L.geoJSON(data, {
            style: function (feature) {
                var greenIdx = stats.getRangeNum(feature.properties.usd_per_ha)
                return {
                    opacity: 0.9,
                    fillOpacity: 0.8,
                    color: greens[greenIdx],
                    fillColor: greens[greenIdx]
                };
            }
        }).bindPopup(function (layer) {
            var props = layer.feature.properties;
            var html = '';
            html += 'ID Polígono: <span style="font-weight: bold">' + props.gid + '</span><br/>';
            html += 'Descripción: <span style="font-weight: bold">' + props.description + '</span><br/>';
            html += 'Valor Ecológico Anual: <span style="font-weight: bold">$' + formatMoney(props.total_assess_val, 2) + '</span><br/>';
            html += 'Área en Hectáreas: <span style="font-weight: bold">' + props.area_ha.toFixed(1) + '</span><br/>';
            html += 'Valor Anual por Hectárea: <span style="font-weight: bold">$' + formatMoney(props.usd_per_ha, 2) + '</span><br/>';
            return html;
        });
        geoJsonLyr.addTo(map);
        L.control.layers([], {'Valoración Ecológica': geoJsonLyr}).addTo(map);
    });


    function formatMoney(n, c, d, t){
        var c = isNaN(c = Math.abs(c)) ? 2 : c,
            d = d == undefined ? "." : d,
            t = t == undefined ? "," : t,
            s = n < 0 ? "-" : "",
            i = String(parseInt(n = Math.abs(Number(n) || 0).toFixed(c))),
            j = (j = i.length) > 3 ? j % 3 : 0;
        return s + (j ? i.substr(0, j) + t : "") + i.substr(j).replace(/(\d{3})(?=\d)/g, "$1" + t) + (c ? d + Math.abs(n - i).toFixed(c).slice(2) : "");
    };


</script>


</body>
</html>
